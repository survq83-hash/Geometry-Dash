<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Geometry Dash — Stable Build (Forest Flight + Burning Heights + Disco Chaos)</title>
<style>
  html,body{height:100%;margin:0;background:#05060d;font-family:Inter, Arial, sans-serif;}
  canvas{display:block;margin:0 auto;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
  #hint{position:fixed;left:12px;bottom:12px;color:#ddd;font-size:13px;background:rgba(0,0,0,0.25);padding:8px;border-radius:8px}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="hint">Tap level buttons on mobile • Tap to jump/use ability • R: return to menu</div>
<script>
// ---------- CORE SETUP ----------
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
function resizeCanvas(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// ---------- GAME STATE & PERSISTENCE ----------
let gameState = 'menu';
let currentLevel = 1;
let score = 0;
let lastScore = 0;
let bestScores = JSON.parse(localStorage.getItem('gd_bestScores')) || Array(8).fill(0);
while(bestScores.length < 8) bestScores.push(0);

// ---------- PLAYER ----------
let player = { x:160, y:0, w:32, h:32, vy:0, gravity:0.55, jumpPower:12, jumpCount:0, maxJumps:2, mode:'cube', color:'#00e6ff' };

// ---------- WORLD ----------
let obstacles = [], decor = [], parallax = [], particles = [];
let obstacleTimer = 0;

// ---------- LEVELS ----------
const LEVELS = [
  {name:'Neon Classic', palette:['#7a4bff','#2b1b63','#120916'], interval:70, minH:90, maxH:150, speed:4},
  {name:'Blue Pulse', palette:['#4bc8ff','#07304d','#021522'], interval:90, minH:80, maxH:140, speed:5},
  {name:'Solar UFO', palette:['#ff7a33','#3d1200','#2b0f06'], interval:110, minH:60, maxH:120, speed:4.2, midAir:true},
  {name:'Emerald Flight', palette:['#4bff8a','#07321a','#02190f'], interval:100, minH:70, maxH:130, speed:5.2},
  {name:'Cyan Wave', palette:['#00fff3','#05343a','#021516'], interval:120, minH:50, maxH:100, speed:5.6},
  {name:'Forest Flight', palette:['#00ff55','#017a1a','#004d0f'], interval:90, minH:80, maxH:180, speed:4.5, midAir:true},
  {name:'Burning Heights', palette:['#ff4b2b','#ff9a3c','#6b0b00'], interval:80, minH:60, maxH:140, speed:5.2, midAir:true, lava:true},
  {name:'Disco Chaos', palette:[], interval:50, minH:60, maxH:120, speed:5, disco:true}
];

// ---------- UTIL ----------
function rand(a,b){return a + Math.random()*(b-a);} 
function rectIntersect(a,b){ return !(a.x + a.w < b.x || a.x > b.x + b.w || a.y + a.h < b.y || a.y > b.y + b.h); }

// ---------- SETUP PER LEVEL ----------
function setPlayerForLevel(level){
  const lv = LEVELS[level-1];
  switch(level){
    case 1: case 2: case 8: player.mode='cube'; player.maxJumps=2; break;
    case 3: case 6: case 7: player.mode='UFO'; player.maxJumps=1; break;
    case 4: player.mode='plane'; player.maxJumps=1; break;
    case 5: player.mode='wave'; player.maxJumps=0; break;
  }
  // Ensure player is always visible
  if(level === 8){ // Disco Chaos
    player.color = '#000000';
  } else {
    player.color = lv.palette && lv.palette[0] ? lv.palette[0] : '#00e6ff';
  }
}

function createDecorForLevel(level){
  const lv = LEVELS[level-1];
  parallax = []; decor = []; particles = [];
  for(let i=0;i<3;i++) parallax.push({x:0,y:i*60,w:canvas.width,h:canvas.height,color:lv.palette[i%3]||'#000',alpha:0.06*(i+1)});
  for(let i=0;i<18;i++) decor.push({x:Math.random()*canvas.width*1.4 - canvas.width*0.2, y:Math.random()*canvas.height*0.6 + 20, r:6+Math.random()*22, color:lv.palette[i%3]||'#fff', alpha:0.09});
  for(let i=0;i<30;i++) particles.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, vy: -0.15 - Math.random()*0.5, life: 30+Math.random()*80, size: 1+Math.random()*3});
}

// ---------- DRAW PLAYER ----------
function drawPlayer(){
  ctx.save();
  ctx.shadowColor = player.color;
  ctx.shadowBlur = 20;
  ctx.fillStyle = player.color;
  ctx.fillRect(player.x, player.y, player.w, player.h);
  ctx.restore();
}

// ---------- GAME LOOP ----------
function update(){
  drawBackground();
  drawParallax();
  drawDecor();
  updateParticles();

  if(gameState==='menu'){ drawMenu(); requestAnimationFrame(update); return; }
  if(gameState==='dead'){ ctx.fillStyle='white'; ctx.font='22px Inter, Arial'; ctx.fillText('You Died at: '+lastScore+' — Tap or press R to return', 20, canvas.height*0.5); requestAnimationFrame(update); return; }

  // Player physics
  player.vy += player.gravity; 
  player.y += player.vy;
  if(currentLevel===7){ if(player.y + player.h >= canvas.height) handleDeath(); } 
  else { if(player.y + player.h > canvas.height){ player.y = canvas.height - player.h; player.vy = 0; player.jumpCount = 0; } }

  spawnObstacles(); updateObstacles();

  if(currentLevel===7){ drawLavaGround(); drawHeatShimmer(); }

  drawPlayer();

  score++; 
  ctx.fillStyle='#fff'; 
  ctx.font='18px Inter, Arial'; 
  ctx.fillText('Score: '+score,12,26);
  requestAnimationFrame(update);
}

// ---------- START ----------
resetGame();
update();
</script>
</body>
</html>

