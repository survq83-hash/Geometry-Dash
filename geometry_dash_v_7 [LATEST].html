<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Geometry Dash — V3 Modern</title>
<style>
  html,body{height:100%;margin:0;background:#05060d;font-family:Inter, Arial, sans-serif;}
  canvas{display:block;margin:0 auto;filter:drop-shadow(0 0 24px #0008);} 
  #hint{position:fixed;left:12px;bottom:12px;color:#ddd;font-size:13px;background:rgba(0,0,0,0.25);padding:8px;border-radius:8px}
</style>
</head>
<body>
<canvas id="game" width="1100" height="600"></canvas>
<div id="hint">1-5: select level • Space / ↑ / Mouse: action • R: menu</div>
<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const W = canvas.width, H = canvas.height;

// --- GAME STATE ---
let gameState = 'menu';
let currentLevel = 1;
let score = 0;
let speedMult = 1;

// --- PLAYER ---
let player = {x:160,y:420,w:32,h:32,vy:0,gravity:0.55,jumpPower:12,onGround:false,jumpCount:0,maxJumps:2,mode:'cube',color:'#00e6ff',trail:[]};

// --- ENTITIES ---
let obstacles = [], decor = [], parallax = [];
let obstacleTimer = 0;

// --- LEVELS ---
const LEVELS = [
  {name:'Neon Classic', palette:['#7a4bff','#2b1b63','#120916'], interval:70, minH:90, maxH:150, speed:4, theme:'tech'},
  {name:'Blue Pulse', palette:['#4bc8ff','#07304d','#021522'], interval:90, minH:80, maxH:140, speed:5, theme:'aquatic'},
  {name:'Solar UFO', palette:['#ff7a33','#3d1200','#2b0f06'], interval:110, minH:60, maxH:120, speed:4.2, theme:'lava'},
  {name:'Emerald Flight', palette:['#4bff8a','#07321a','#02190f'], interval:100, minH:70, maxH:130, speed:5.2, theme:'jungle'},
  {name:'Cyan Wave', palette:['#00fff3','#05343a','#021516'], interval:120, minH:50, maxH:100, speed:5.6, theme:'cyber'}
];

// --- UTILS ---
function rand(a,b){return a+Math.random()*(b-a);} 
function rectIntersect(a,b){return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y}
function roundRect(ctx,x,y,w,h,r,fill,stroke){if(fill)ctx.fillRect(x,y,w,h);if(stroke)ctx.strokeRect(x,y,w,h);}

// --- RESET ---
function resetGame(){
  player.y=420;player.vy=0;player.jumpCount=0;player.trail=[];
  obstacles=[];decor=[];parallax=[];obstacleTimer=0;score=0;speedMult=1;
  setPlayerForLevel(currentLevel);
  createDecorForLevel(currentLevel);
}

function setPlayerForLevel(level){
  const lv=LEVELS[level-1];
  switch(level){
    case 1: case 2: player.mode='cube'; player.maxJumps=2; player.color=lv.palette[0]; break;
    case 3: player.mode='UFO'; player.maxJumps=1; player.color=lv.palette[0]; break;
    case 4: player.mode='plane'; player.maxJumps=1; player.color=lv.palette[0]; break;
    case 5: player.mode='wave'; player.maxJumps=0; player.color=lv.palette[0]; break;
  }
}

function createDecorForLevel(level){
  const lv=LEVELS[level-1];
  for(var i=0;i<4;i++) parallax.push({x:0,y:50*i,w:W,h:H,speed:0.1*(i+1),color:lv.palette[(i+1)%lv.palette.length],alpha:0.06*(i+1)});
  for(var i=0;i<18;i++) decor.push({x:Math.random()*W*2-W,y:Math.random()*H*0.7,r:10+Math.random()*40,rot:Math.random()*Math.PI,speed:0.1+Math.random()*0.4,color:lv.palette[i%lv.palette.length],alpha:0.07});
}

// --- DRAW PARALLAX ---
function drawParallax(){
  parallax.forEach(function(layer){
    ctx.save();
    ctx.globalAlpha = layer.alpha;
    ctx.fillStyle = layer.color;
    ctx.fillRect(layer.x, layer.y, layer.w, layer.h);
    ctx.restore();
  });
}

// --- DRAW DECOR ---
function drawDecor(){
  decor.forEach(function(d){
    ctx.save();
    ctx.globalAlpha=d.alpha;
    ctx.fillStyle=d.color;
    ctx.beginPath();
    ctx.arc(d.x,d.y,d.r,0,Math.PI*2);
    ctx.fill();
    ctx.restore();
  });
}

// --- SPAWN OBSTACLES ---
function spawnObstacles(){
  var lv=LEVELS[currentLevel-1];
  obstacleTimer++;
  if(obstacleTimer>lv.interval){
    obstacleTimer=0;
    var baseH=lv.minH+Math.random()*(lv.maxH-lv.minH);
    var x=W+80;

    if(currentLevel===3){
      if(Math.random()<0.35){obstacles.push({type:'airSpike',x:x,y:rand(120,360),w:28,h:28});}
      else if(Math.random()<0.18){obstacles.push({type:'laser',x:x,y:rand(150,350),w:90,h:12,dir:(Math.random()>0.5?1:-1),t:0});}
      else addGroundObstacle(x,baseH,lv);
    } else addGroundObstacle(x,baseH,lv);
  }
}
function addGroundObstacle(x,baseH,lv){
  var typeRoll=Math.random();
  if(typeRoll<0.55) obstacles.push({type:'block',x:x,y:H-baseH,w:40,h:baseH,color:lv.palette[0]});
  else if(typeRoll<0.7){var spikes=1+Math.floor(Math.random()*3); for(var i=0;i<spikes;i++) obstacles.push({type:'spike',x:x+i*28,y:H-baseH-28,w:28,h:28});}
  else if(typeRoll<0.82) obstacles.push({type:'saw',x:x,y:H-(baseH/2)-24,r:20,angle:0,speed:1+Math.random()});
  else if(typeRoll<0.9){var modes=['UFO','plane','wave','cube'];var mode=modes[Math.floor(Math.random()*modes.length)]; obstacles.push({type:'portal',x:x,y:H-baseH-72,w:40,h:40,mode:mode});}
  else {var meta=Math.random()>0.5?{kind:'speed',factor:1.5}:{kind:'jump'}; obstacles.push({type:meta.kind==='speed'?'speed':'jump',x:x,y:H-baseH-28,w:34,h:28,meta:meta});}
}

// --- DRAW OBSTACLES ---
function drawObstacle(o){
  ctx.save();
  if(o.type==='airSpike'){ctx.fillStyle='#ffaaaa';ctx.beginPath();ctx.moveTo(o.x,o.y+o.h);ctx.lineTo(o.x+o.w/2,o.y);ctx.lineTo(o.x+o.w,o.y+o.h);ctx.closePath();ctx.fill();}
  if(o.type==='laser'){ctx.fillStyle='#ff2222aa';ctx.fillRect(o.x,o.y,o.w,o.h);}
  if(o.type==='block'){var col=o.color||'#8844ff';ctx.fillStyle=col+'cc';ctx.shadowColor=col;ctx.shadowBlur=24;roundRect(ctx,o.x,o.y,o.w,o.h,6,true,false);}
  if(o.type==='spike'||o.type==='airSpike'||o.type==='laser'){if(rectIntersect(player,o)) die();}
  if(o.type==='saw'){ctx.translate(o.x,o.y);ctx.rotate(o.angle);ctx.fillStyle='#ddd';ctx.beginPath();ctx.arc(0,0,o.r,0,Math.PI*2);ctx.fill();ctx.fillStyle='#bbb';for(var i=0;i<8;i++){ctx.save();ctx.rotate(i*(Math.PI*2/8));ctx.beginPath();ctx.moveTo(o.r,-6);ctx.lineTo(o.r+8,0);ctx.lineTo(o.r,6);ctx.closePath();ctx.fill();ctx.restore();}}
  if(o.type==='portal'){ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(o.x+o.w/2,o.y+o.h/2,20,0,Math.PI*2);ctx.fill();ctx.fillStyle='#000';ctx.beginPath();ctx.arc(o.x+o.w/2,o.y+o.h/2,12,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fff';ctx.font='12px Arial';ctx.fillText(o.mode,o.x-10,o.y+o.h+14);}
  if(o.type==='speed'){ctx.fillStyle='#ffd166';roundRect(ctx,o.x,o.y,o.w,o.h,6,true,false);ctx.fillStyle='#000';ctx.font='12px Arial';ctx.fillText('SPD',o.x+6,o.y+20);}
  if(o.type==='jump'){ctx.fillStyle='#66f';roundRect(ctx,o.x,o.y,o.w,o.h,6,true,false);ctx.fillStyle='#fff';ctx.font='12px Arial';ctx.fillText('JMP',o.x+6,o.y+20);}
  ctx.restore();
}

// --- UPDATE LOOP ---
function update(){
  var lv=LEVELS[currentLevel-1];
  ctx.clearRect(0,0,W,H);
  var g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'rgba(0,0,0,0)'); g.addColorStop(1,'rgba(0,0,0,0.6)'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

  if(gameState==='menu'){drawMenu();requestAnimationFrame(update);return;}
  if(gameState==='dead'){drawDead();requestAnimationFrame(update);return;}

  drawParallax(); drawDecor();
  spawnObstacles();

  if(player.mode==='cube'){player.vy+=player.gravity;player.y+=player.vy;if(player.y+player.h>=H-40){player.y=H-40-player.h;player.vy=0;player.onGround=true;player.jumpCount=0;} else player.onGround=false;}
  if(player.mode==='UFO'){player.vy+=0.18;player.y+=player.vy;if(player.y+player.h>=H-40){player.y=H-40-player.h;player.vy=0;player.onGround=true;} else player.onGround=false;}
  if(player.mode==='plane'){player.y+=player.vy;player.vy+=0.6;if(player.y+player.h>=H-40){player.y=H-40-player.h;player.vy=0;player.onGround=true;} else player.onGround=false;}
  if(player.mode==='wave'){player.y=200+Math.sin(score*0.06)*120;}

  ctx.save(); ctx.shadowColor=player.color; ctx.shadowBlur=24; ctx.fillStyle=player.color; ctx.fillRect(player.x,player.y,player.w,player.h); ctx.restore();

  for(var i=obstacles.length-1;i>=0;i--){
    var obs=obstacles[i];
    if(obs.type==='laser'){obs.t+=0.04;obs.y+=Math.sin(obs.t)*1.8*obs.dir; obs.x-=lv.speed*speedMult;} else if(obs.type==='saw') {obs.x-=lv.speed*speedMult; obs.angle+=0.15*obs.speed;} else {obs.x-=lv.speed*speedMult;}
    drawObstacle(obs);
    if(obs.type==='block' || obs.type==='spike' || obs.type==='airSpike' || obs.type==='laser'){if(rectIntersect(player,obs)) die();}
    if(obs.type==='saw'){var dx=(player.x+player.w/2)-obs.x; var dy=(player.y+player.h/2)-obs.y; if(Math.hypot(dx,dy)<obs.r+10) die();}
    if(obs.type==='portal'){if(Math.abs((player.x+player.w/2)-(obs.x+obs.w/2))<30 && Math.abs((player.y+player.h/2)-(obs.y+obs.h/2))<30){setTimeout(function(){player.mode=obs.mode;},30);obstacles.splice(i,1);}}
    if(obs.type==='speed'){if(rectIntersect(player,obs)){speedMult=obs.meta?obs.meta.factor:1.5;setTimeout(function(){speedMult=1;},2200);obstacles.splice(i,1);}}
    if(obs.type==='jump'){if(rectIntersect(player,obs)){player.vy=-14;obstacles.splice(i,1);}}
    if(obs.x+(obs.w||0)<-200) obstacles.splice(i,1);
  }

  score++;
  ctx.fillStyle='#ffffff88'; ctx.font='18px Inter, Arial'; ctx.fillText('Level '+currentLevel+' - '+lv.name,16,28);
  ctx.fillText('Score: '+Math.floor(score/10),16,54);

  requestAnimationFrame(update);
}

function die(){gameState='dead';}
function doAction(){if(gameState==='menu'||gameState==='dead') return;if(player.mode==='cube'&&player.jumpCount<player.maxJumps){player.vy=-player.jumpPower;player.jumpCount++;} if(player.mode==='UFO') player.vy=-6; if(player.mode==='plane') player.vy=-7;}

document.addEventListener('keydown',function(e){if(gameState==='menu'&&['1','2','3','4','5'].includes(e.key)){currentLevel=parseInt(e.key);resetGame();gameState='play';}if(gameState==='play'&&(e.key===' '||e.key==='ArrowUp')) doAction(); if(gameState==='dead'&&e.key.toLowerCase()==='r') gameState='menu';});
canvas.addEventListener('mousedown',function(){if(gameState==='play') doAction();});
canvas.addEventListener('touchstart',function(ev){ev.preventDefault(); if(gameState==='play') doAction();},{passive:false});

// --- MENU & DRAW ---
function drawMenu(){ctx.fillStyle='#03040a66';ctx.fillRect(0,0,W,H);ctx.fillStyle='#fff';ctx.font='40px Inter, Arial';ctx.fillText('Geometry Dash — Modern (V3)',180,120);ctx.font='20px Inter, Arial';ctx.fillText('Select a Level (1-5) — Modern decorations, hazards, portals & particles',160,160);
for(var i=1;i<=5;i++){var x=220,y=200+i*44;ctx.fillStyle=LEVELS[i-1].palette[0];ctx.fillRect(x,y-28,220,36);ctx.fillStyle='#000';ctx.font='18px Inter, Arial';ctx.fillText(i+' - '+LEVELS[i-1].name,x+12,y);}}
function drawDead(){ctx.fillStyle='rgba(0,0,0,0.45)';ctx.fillRect(0,0,W,H);ctx.fillStyle='#fff';ctx.font='36px Inter, Arial';ctx.fillText('You Died',460,260);ctx.font='18px Inter, Arial';ctx.fillText('Press R to return to menu',430,300);}

// --- START ---
resetGame(); update();

// --- Persistent Stats ---
var saveData=JSON.parse(localStorage.getItem('gd_save')||'{}');
function ensureLevelStats(lvl){if(!saveData[lvl]) saveData[lvl]={best:0,attempts:0,jumps:0,modes:{cube:0,ufo:0,ship:0,wave:0}};}
function saveStats(){localStorage.setItem('gd_save',JSON.stringify(saveData));}
function startLevel(lvl){ensureLevelStats(lvl);saveData[lvl].attempts++;saveStats();resetGame();gameState='play';}
function trackJump(lvl){ensureLevelStats(lvl);saveData[lvl].jumps++;saveStats();}
function trackMode(lvl,mode){ensureLevelStats(lvl);saveData[lvl].modes[mode]++;saveStats();}
function recordScore(lvl,score){ensureLevelStats(lvl);if(score>saveData[lvl].best){saveData[lvl].best=score;saveStats();}}
</script>
</body>
</html>
